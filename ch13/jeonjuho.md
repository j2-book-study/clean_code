# 동시성

- 겉으로 보기에는 멀쩡할 수 있는 다중 스레드 코드를 짜게되면 시스템이 부하를 받았을 때 문제가 발견될 수 있다.

## 동시성이 필요한 이유

- 동시성은 결합(Coupling)을 없애는 전략이다. 즉, 무엇과 언제를 분리하는 전략이다.
- 구조적인 관점에서 프로그램은 작은 협력 프로그램 여럿으로 나뉜 것으로 보이게되며, 시스템을 이해하고 문제를 분리하기 쉬워진다.
- 응답 시간과 작업 처리량 개선을 위해서 다중 스레드를 사용하고, 이를 위해서 동시성을 채택하기도 한다.

## 미신과 오해

- 여러 프로세스가 동시에 처리할 독립적인 계산이 충분히 많은 경우에만 성능이 높아진다.
- 단일 스레드 시스템과 다중 스레드 시스템은 설계가 판이하게 다르다.
- 웹 또는 EJB 컨테이너를 사용하더라도 어떻게 동시 수정, 데드락 등과 같은 문제를 피할 수 있는 지를 알아야만 한다.

## 난관

- 공유되는 자원이 있는 상황에서 다중 스레드는 의도하지 않은 결과가 발생될 수도 있다.

## 동시성 방어 원칙

### 단일 책임 원칙 (SRP)

- 동시성 관련 코드는 다른 코드와 분리해야 한다.

### 따름 정리: 자료 범위를 제한하라

- 공유 객체를 사용하는 코드 내 임계영역을 synchronized 키워드로 보호할 필요가 있다.
- 자료를 캡슐화하고 공유 자료를 최대한 줄여라.

### 따름 정리: 자료 사본을 사용하라

- 각 스레드가 객체의 사본을 통해 결과를 도출한다.

### 따름 정리: 스레드는 가능한 독립적으로 구현하라

- 다른 스레드와 자료를 공유하지 않는 스레드를 구현하라.
- 독자적인 스레드로, 가능하면 다른 프로세스에서 돌려도 괜찮도록 자료를 독립적인 단위로 분할하라.

## 라이브러리를 이해하라

- 일부 클래스 라이브러리는 스레드에 안전하지 못할 수 있다.

## 실행 모델을 이해하라

### 생산자 - 소비자

- 서로가 진행 가능함에도 동시에 서로에게서 시그널을 기다릴 가능성이 존재한다.

### 읽기 - 쓰기

- 읽기와 쓰기 스레의 요구를 적절히 만족시키지 않으면 처리율이 떨어지거나 기아 상태에 빠지게 된다.

### 식사하는 철학자들

- 교착 상태 발생 규칙
    - Mutual exclusion (상호 배제)
    - Hold and wait
    - No preemtion (선점 방지)
    - Circular wait (순환 대기)
- 해결법
    - 최대 n-1명만 동시에 식사할 수 있도록 제한
        - 최소 1명은 식사 가능
        - 순환 대기 조건을 깨뜨려 교착 상태를 예방
    - 젓가락을 동시에 두 개 잡는 방식
        - 젓가락 두 개를 동시에 집을 수 있을 때만 집고, 그렇지 않으면 대기
        - Hold and wait 조건을 제거하여 교착 상태를 예방
    - 비대칭적 자원 획득
        - 철학자마다 젓가락을 집는 순서를 다르게
        - 순환 대기가 발생하지 않게 되어 교착 상태를 예방
    - 각각의 철학자 상태 구분
        - 양쪽 이웃이 식사 중이 아닐 때만 젓가락을 집음
        - 조건 변수를 사용해 젓가락을 집을 수 없는 경우 대기
        - 동기화 문제를 해결하고 교착 상태를 예방할 수 있지만, 기아 상태를 완전히 막지는 못함

## 동기화하는 메서드 사이에 존재하는 의존성을 이해하라

- 공유 객체 하나에는 메서드 하나만 사용하라
- 여러 메서드를 사용해야 한다면
    - 클라이언트에서 첫 번째 메서드를 호출하기 전부터 마지막 메서드를 호출할 때까지 서버를 잠근다.
    - 서버에 본인을 잠그고 해제하는 메서드를 구현해서 클라이언트가 호출할 수 있도록 한다.
    - 기존 서버를 유지하고 연결 서버에서 잠금을 수행하는 중간 단계를 생성한다.

## 동기화하는 부분을 작게 만들어라

- 락은 스레드를 지연시키고 부하를 가중시키므로 임계영역 수를 최대한 줄여야 한다.
- 임계영역의 크기가 커지면 스레드 간에 경쟁이 늘어나고 프로그램 성능이 떨어질 수 있으므로 주의해야 한다.

## 올바른 종료 코드는 구현하기 어렵다.

- 다양한 상황에서 데드락이 발생될 가능성이 높다.

## 스레드 코드 테스트하기

- 시스템 실패를 일회성이 아닌 잠정적인 스레드 문제로 취급하라.
- 다중 스레드를 고려하지 않은 코드부터 테스트를 성공하자.
- 다중 스레드를 쓰는 코드 부분을 다양한 환경에 쉽게 끼워 넣을 수 있도록 하여 다양한 환경과 상황으로 테스트를 돌려라.
- 스와핑이 잦아지도록 프로세서 수보다 많은 스레드를 돌려 임계여역을 빼먹은 코드나 데드락을 일으키는 코드를 찾아라.
- 보조 코드를 활용하여 강제로 실패를 유도하고, 드물게 발생하는 오류의 빈도를 높여라.
    - 직접 구현하거나 자동화 도구를 사용할 수 있다.

## 결론

- 임계영역의 코드를 최대한 분리하고 다양한 상황으로 테스트해라!